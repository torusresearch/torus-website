<template>
  <div class="activity-table">
    <TransactionDetails
      v-for="transaction in pagedTransactions"
      :key="transaction.transaction_hash || transaction.id"
      :transaction="transaction"
      :currency-multiplier="currencyMultiplier"
      :selected-currency="selectedCurrency"
      :cancel-gas-price="cancelGasPrice"
      @cancelTransaction="cancelTransaction"
    />
    <div v-if="!$vuetify.display.xs && pageCount > 1" class="text-center pt-6">
      <v-pagination
        v-model="page"
        class="activity-pagination"
        prev-icon="$page_prev"
        next-icon="$page_next"
        :length="pageCount"
        :total-visible="7"
      ></v-pagination>
    </div>
  </div>
</template>

<script>
import BigNumber from 'bignumber.js'

import { ACTIVITY_ACTION_ALL, ACTIVITY_PERIOD_ALL, ACTIVITY_PERIOD_MONTH_ONE, ACTIVITY_PERIOD_WEEK_ONE } from '../../../utils/enums'
import TransactionDetails from '../TransactionDetails'

export default {
  components: {
    TransactionDetails,
  },
  props: {
    transactions: {
      type: Array,
      default() {
        return []
      },
    },
    selectedAction: {
      type: String,
      default: '',
    },
    selectedPeriod: {
      type: String,
      default: '',
    },
    currencyMultiplier: {
      type: BigNumber,
      default: new BigNumber('0'),
    },
    selectedCurrency: {
      type: String,
      default: 'USD',
    },
    cancelGasPrice: {
      type: BigNumber,
      default: new BigNumber('5'),
    },
  },
  data() {
    return {
      page: 1,
      itemsPerPage: 8,
      expanded: [],
      pagination: {},
      defaultSort: 'date',
    }
  },
  computed: {
    showFooter() {
      return this.transactions && this.transactions.length > 5
    },
    pageCount() {
      return Math.ceil(this.filteredTransactions.length / this.itemsPerPage)
    },
    oneWeekAgoDate() {
      const minDate = new Date()
      return minDate.setDate(minDate.getDate() - 7)
    },
    oneMonthAgoDate() {
      const minDate = new Date()
      return minDate.setMonth(minDate.getMonth() - 1)
    },
    sixMonthAgoDate() {
      const minDate = new Date()
      return minDate.setMonth(minDate.getMonth() - 6)
    },
    filteredTransactions() {
      const selectedAction = this.selectedAction === ACTIVITY_ACTION_ALL ? '' : this.selectedAction
      const regExAction = new RegExp(selectedAction, 'i')

      const transactions = this.transactions.filter((item) => {
        // GET Date Scope
        let isScoped = false
        if (this.selectedPeriod === ACTIVITY_PERIOD_ALL) {
          isScoped = true
        } else {
          let minDate
          const itemDate = new Date(item.date)
          if (this.selectedPeriod === ACTIVITY_PERIOD_WEEK_ONE) {
            minDate = this.oneWeekAgoDate
          } else if (this.selectedPeriod === ACTIVITY_PERIOD_MONTH_ONE) {
            minDate = this.oneMonthAgoDate
          } else {
            minDate = this.sixMonthAgoDate
          }
          isScoped = minDate <= itemDate.getTime()
        }

        if (item.action) {
          return item.action.match(regExAction) && isScoped
        }
        return isScoped
      })

      return transactions
    },
    pagedTransactions() {
      const transactions = this.filteredTransactions.slice((this.page - 1) * this.itemsPerPage, this.page * this.itemsPerPage)

      return transactions
    },
  },
  methods: {
    changeSort(column) {
      if (this.pagination.sortBy === column) {
        this.pagination.descending = !this.pagination.descending
      } else {
        this.pagination.sortBy = column
        this.pagination.descending = false
      }
    },
    rowClicked(item) {
      if (this.expanded.includes(item)) {
        this.expanded = []
      } else {
        this.expanded = [item]
      }
    },
    cancelTransaction(transaction) {
      this.$emit('cancelTransaction', transaction)
    },
  },
}
</script>

<style lang="scss" scoped>
@import 'TxHistoryTable.scss';
</style>
